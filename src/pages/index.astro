---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import ThemeToggle from "../components/ThemeToggle.astro";

const projects = await getCollection("projects").catch(() => []);
const publications = await getCollection("publications").catch(() => []);
const art = await getCollection("art").catch(() => []);
const featured = Array.isArray(projects) ? projects.slice(0, 3) : [];
---

<BaseLayout
  title="Piyush Jain - Portfolio"
  description="Welcome to my portfolio and personal website"
>
  <!-- Content wrapper for proper navbar positioning -->
  <div class="container-wrapper">
    <!-- Floating navbar island (transitions to sticky top) -->
    <div class="home-island sticky z-40 hidden md:block">
      <nav
        class="lg-base-pill px-3 py-2 border flex items-center gap-1"
        data-lg-island
        style="position: relative; overflow: visible;"
      >
        <!-- Moving glass selector -->
        <span
          class="lg-glass-selector lg-distort"
          data-lg-selector
          aria-hidden="true"></span>

        <a href="/" class="lg-island-link" data-lg-item="true">Home</a>
        <a href="/academics" class="lg-island-link" data-lg-item="true"
          >Academics</a
        >
        <a
          href="/publications-research-projects"
          class="lg-island-link"
          data-lg-item="true"
        >
          Publications, Research &amp; Projects
        </a>
        <a href="/art" class="lg-island-link" data-lg-item="true">Art</a>
        <a href="/experience" class="lg-island-link" data-lg-item="true"
          >Experience</a
        >
        <a href="/resume" class="lg-island-link" data-lg-item="true">Resume</a>

        <div class="relative z-[2] ml-1">
          <ThemeToggle />
        </div>
      </nav>
    </div>

    <!-- SVG filter for glass distortion -->
    <svg
      width="0"
      height="0"
      aria-hidden="true"
      focusable="false"
      style="position:absolute"
    >
      <filter
        id="lg-glass-distort"
        x="-20%"
        y="-20%"
        width="140%"
        height="140%"
        color-interpolation-filters="sRGB"
      >
        <!-- Displacement map for convex bezel refraction (generated by JS) -->
        <feImage id="lg-displacement-image" href="" result="displacement_map"
        ></feImage>
        <feDisplacementMap
          in="SourceGraphic"
          in2="displacement_map"
          scale="60"
          xChannelSelector="R"
          yChannelSelector="G"></feDisplacementMap>
      </filter>
    </svg>

    <!-- Page content grid: left about sidebar + right main -->
    <div class="lg:grid lg:grid-cols-[minmax(280px,380px)_1fr] lg:gap-8">
      <!-- Left: About / Identity Sidebar (mobile becomes top card) -->
      <div class="lg:block">
        <!-- Mobile: stacked about card -->
        <div class="lg:hidden mb-6">
          <aside
            class="rounded-2xl border border-[rgb(var(--border-color))] bg-[rgb(var(--bg-primary))] p-6"
          >
            <h2 class="text-2xl font-bold mb-2">Hi, I'm Piyush Jain</h2>
            <p class="text-[rgb(var(--text-secondary))]">
              About me – identity blurb. Content coming soon.
            </p>
          </aside>
        </div>

        <!-- Desktop: morphing tall card -> full-height sticky sidebar -->
        <div class="hidden lg:block lg:sticky lg:top-0 home-sidebar-container">
          <aside
            class="home-sidebar border border-[rgb(var(--border-color))] bg-[rgb(var(--bg-primary))]"
          >
            <div class="p-6">
              <h2 class="text-3xl font-bold mb-3">Hi, I'm Piyush Jain</h2>
              <p class="text-[rgb(var(--text-secondary))] mb-4">
                I work across research, engineering, and creative practice.
              </p>
              <div class="flex gap-3">
                <a
                  href="/publications-research-projects"
                  class="px-4 py-2 rounded-md bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200"
                  >View Work</a
                >
                <a
                  href="/resume"
                  class="px-4 py-2 rounded-md border border-[rgb(var(--border-color))] hover:bg-slate-50 dark:hover:bg-slate-800"
                  >Resume</a
                >
              </div>
            </div>
          </aside>
        </div>
      </div>

      <!-- Right: Main content (Hero + Resume-like sections) -->
      <div class="main-column">
        <!-- Hero: full viewport -->
        <section
          id="hero"
          class="min-h-screen pt-8 pb-14 md:pt-12 md:pb-16 lg:pt-14 lg:pb-20 flex flex-col justify-start"
        >
          <div class="max-w-3xl">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">
              Hi, I'm <span class="text-slate-700 dark:text-slate-300"
                >Piyush Jain</span
              >
            </h1>
            <p
              class="text-lg md:text-xl text-[rgb(var(--text-secondary))] mb-8"
            >
              Featured work and directions below. Explore publications,
              research, and projects.
            </p>
            <div class="flex flex-wrap gap-4 mb-10">
              <a
                href="/publications-research-projects"
                class="px-6 py-3 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-md font-medium hover:bg-slate-800 dark:hover:bg-slate-200 transition-colors"
                >Explore Work</a
              >
              <a
                href="/resume"
                class="px-6 py-3 border border-[rgb(var(--border-color))] rounded-md font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                >View Resume</a
              >
            </div>
          </div>

          <!-- Featured Projects grid (layout placeholders or real items) -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {
              featured && featured.length > 0
                ? featured.map((item) => (
                    <div class="rounded-xl border border-[rgb(var(--border-color))] p-5 hover:shadow-md transition-shadow bg-[rgb(var(--bg-secondary))]">
                      <h3 class="text-lg font-semibold mb-1">
                        {item.data?.title ?? "Featured"}
                      </h3>
                      <p class="text-sm text-[rgb(var(--text-secondary))] line-clamp-3">
                        {item.data?.description ?? "Featured item"}
                      </p>
                    </div>
                  ))
                : [1, 2, 3].map((n) => (
                    <div class="rounded-xl border border-[rgb(var(--border-color))] p-5 hover:shadow-md transition-shadow bg-[rgb(var(--bg-secondary))]">
                      <h3 class="text-lg font-semibold mb-1">Featured</h3>
                      <p class="text-sm text-[rgb(var(--text-secondary))]">
                        Coming soon
                      </p>
                    </div>
                  ))
            }
          </div>
        </section>

        <!-- Resume-like scroll sections -->
        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Academics</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/academics" class="text-sm font-medium underline">See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">
            Publications, Research & Projects
          </h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-3">
            {
              (publications?.slice(0, 3) || []).map((p) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {p.data?.title ?? "Publication"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {p.data?.venue ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (projects?.slice(0, 3) || []).map((prj) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {prj.data?.title ?? "Project"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {prj.data?.description ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (publications?.length ?? 0) + (projects?.length ?? 0) === 0 && (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm">Content coming soon.</div>
                </div>
              )
            }
          </div>
          <a
            href="/publications-research-projects"
            class="text-sm font-medium underline">See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Art</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-3">
            {
              (art?.slice(0, 3) || []).map((a) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {a.data?.title ?? "Art"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {a.data?.medium ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (art?.length ?? 0) === 0 && (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm">Content coming soon.</div>
                </div>
              )
            }
          </div>
          <a href="/art" class="text-sm font-medium underline">See more</a>
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Experience</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/experience" class="text-sm font-medium underline"
            >See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Resume</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/resume" class="text-sm font-medium underline">See more</a>
        </section>
      </div>
    </div>
  </div>

  <!-- Home-only styles and behavior -->
  <style is:global>
    html,
    body {
      overflow-x: clip;
    }

    .container-wrapper {
      max-width: min(96vw, 1600px);
      margin: 0 auto;
      padding: 0 1rem;
      position: relative;
    }

    /* Hide normal navbar on home page only */
    body .site-nav {
      display: none !important;
      visibility: hidden;
    }

    /* Island positioning */
    .home-island {
      top: 1rem;
      display: flex;
      justify-content: center;
      position: sticky;
      transition:
        top 300ms cubic-bezier(0.4, 0, 0.2, 1),
        transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    body[data-nav-scrolled="true"] .home-island {
      top: 0.75rem;
      transform: translateX(var(--nav-shift-x, 0px));
    }

    /* Sidebar container positioning */
    .home-sidebar-container {
      margin-top: 20vh;
      transition: margin-top 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    body[data-sidebar-scrolled="true"] .home-sidebar-container {
      margin-top: 0;
    }

    .home-sidebar {
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      min-height: 100vh;
      padding: 1.5rem;
      position: relative;
      transition:
        border-radius 300ms cubic-bezier(0.4, 0, 0.2, 1),
        border-color 300ms cubic-bezier(0.4, 0, 0.2, 1),
        background-color 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    body[data-sidebar-scrolled="true"] .home-sidebar {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-color: transparent;
      border-bottom-color: transparent;
    }

    body[data-sidebar-scrolled="true"] .home-sidebar::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 2rem;
      width: 1px;
      background: rgb(var(--border-color));
      opacity: 1;
      transition: opacity 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .home-sidebar::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 2rem;
      width: 1px;
      background: rgb(var(--border-color));
      opacity: 0;
      transition: opacity 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>

  <script is:inline>
    // Generate proper radial displacement map with flat center and bezel-only distortion
    const generateDisplacementMap = (width, height, bezelWidth) => {
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;
      const centerX = width / 2;
      const centerY = height / 2;
      const maxRadiusX = width / 2;
      const maxRadiusY = height / 2;

      // Calculate displacement for each pixel
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const dx = x - centerX;
          const dy = y - centerY;

          // Normalize by ellipse equation to handle oval shape
          const normalizedX = dx / maxRadiusX;
          const normalizedY = dy / maxRadiusY;
          const normalized = Math.sqrt(
            normalizedX * normalizedX + normalizedY * normalizedY,
          ); // 0 to 1 for ellipse

          let displaceX = 0;
          let displaceY = 0;

          // Apply displacement ONLY in the bezel (outer ring), keep center flat
          if (normalized > 1 - bezelWidth && normalized <= 1.0) {
            // Linear falloff within bezel area
            const bezelProgress = (normalized - (1 - bezelWidth)) / bezelWidth;
            const falloff = bezelProgress;

            // Magnitude increases from inner bezel edge to outer edge
            const magnitude = falloff * 8;

            // Direction from center (radial)
            const angle = Math.atan2(dy, dx);

            // Displacement vector pointing INWARD for magnification effect
            displaceX = -Math.cos(angle) * magnitude;
            displaceY = -Math.sin(angle) * magnitude;
          }

          const idx = (y * width + x) * 4;

          // Map displacement to 0-255 (128 = no displacement)
          data[idx + 0] = Math.max(
            0,
            Math.min(255, 128 + (displaceX * 127) / 15),
          ); // Red = X
          data[idx + 1] = Math.max(
            0,
            Math.min(255, 128 + (displaceY * 127) / 15),
          ); // Green = Y
          data[idx + 2] = 128; // Blue unused
          data[idx + 3] = 255; // Alpha
        }
      }

      ctx.putImageData(imageData, 0, 0);
      return canvas.toDataURL("image/png");
    };

    // Generate displacement map matching selector aspect ratio with 35% outer ring distortion
    const displacementMapUrl = generateDisplacementMap(155, 63, 0.55); // Bezel width = 35% keeps center flat
    const filterImage = document.querySelector("#lg-displacement-image");
    if (filterImage) {
      filterImage.setAttribute("href", displacementMapUrl);
      console.log("✅ Displacement map generated and applied");
    } else {
      console.error("❌ Could not find #lg-displacement-image element");
    }

    // Liquid glass selector: smooth mouse-follow + proximity-based text highlighting
    (() => {
      const nav = document.querySelector("[data-lg-island]");
      const selector = document.querySelector("[data-lg-selector]");
      if (!nav || !selector) return;

      const items = Array.from(nav.querySelectorAll('[data-lg-item="true"]'));
      if (items.length === 0) return;

      // State
      let mouseX = 0,
        mouseY = 0;
      let currentX = 0,
        currentY = 0,
        currentW = 100,
        currentH = 44;
      let targetX = 0,
        targetY = 0,
        targetW = 100,
        targetH = 44;
      let isHovering = false;
      let activeItem = null;
      let raf = null;
      let lockedY = 0; // Y position locked to navbar center

      // Easing/lerp
      const lerp = (start, end, factor) => start + (end - start) * factor;

      // Get active item from URL
      const getActiveItem = () => {
        const path = window.location.pathname || "/";
        return items.find((a) => a.getAttribute("href") === path) ?? items[0];
      };

      activeItem = getActiveItem();

      // Position selector at active item (idle state)
      const snapToActive = () => {
        if (!activeItem) {
          console.warn("No active item found");
          return;
        }
        const navRect = nav.getBoundingClientRect();
        const itemRect = activeItem.getBoundingClientRect();

        targetX = itemRect.left - navRect.left;
        targetY = itemRect.top - navRect.top;
        targetW = itemRect.width;
        targetH = itemRect.height;

        // Store the locked Y position - centered on navbar
        // Calculate center of navbar and center where selector should be
        const navCenterY = navRect.height / 2;
        const selectorHalfHeight = 63 / 2; // Half of hover height for centering
        lockedY = navCenterY - selectorHalfHeight;

        console.log("Selector position:", {
          targetX,
          targetY,
          targetW,
          targetH,
        });

        // Instant snap on first load
        currentX = targetX;
        currentY = targetY;
        currentW = targetW;
        currentH = targetH;

        updateSelectorCSS();
        selector.setAttribute("data-ready", "true");
      };

      // Wait for layout to be ready
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          snapToActive();
        });
      });

      // Update CSS vars
      const updateSelectorCSS = () => {
        selector.style.setProperty("--lg-x", `${currentX}px`);
        selector.style.setProperty("--lg-y", `${currentY}px`);
        selector.style.setProperty("--lg-w", `${currentW}px`);
        selector.style.setProperty("--lg-h", `${currentH}px`);
      };

      // Animation loop for smooth following
      const animate = () => {
        const ease = 0.15; // Higher = faster, lower = smoother

        currentX = lerp(currentX, targetX, ease);
        currentY = lerp(currentY, targetY, ease);
        currentW = lerp(currentW, targetW, ease);
        currentH = lerp(currentH, targetH, ease);

        updateSelectorCSS();

        // Continue if hovering
        if (isHovering) {
          raf = requestAnimationFrame(animate);
        }
      };

      // Find closest item to mouse
      const findClosestItem = (mx, my) => {
        let closest = null;
        let minDist = Infinity;

        items.forEach((el) => {
          const rect = el.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          const dist = Math.hypot(mx - centerX, my - centerY);

          if (dist < minDist) {
            minDist = dist;
            closest = el;
          }
        });

        return { item: closest, distance: minDist };
      };

      // Highlight closest item
      const updateHighlight = (closest) => {
        items.forEach((el) => {
          if (el === closest) {
            el.classList.add("lg-island-link--highlight");
          } else {
            el.classList.remove("lg-island-link--highlight");
          }
        });
      };

      // Mouse move: smooth follow + proximity highlight (X-axis only)
      nav.addEventListener("mousemove", (e) => {
        if (!isHovering) {
          isHovering = true;
          selector.classList.add("lg-hovering"); // Enable glass effect
          if (raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(animate);
        }

        mouseX = e.clientX;
        mouseY = e.clientY;

        const navRect = nav.getBoundingClientRect();

        // Target position is mouse cursor - both X and Y
        // Expand to 155x63 on hover for overflow effect (15% bigger than before)
        targetX = mouseX - navRect.left - 77.5; // 77.5 = half of 155px width
        targetY = mouseY - navRect.top - 31.5; // 31.5 = half of 63px height // y-restriction: use lockedY to lock Y axis
        targetW = 155; // Expand wider than nav items
        targetH = 63; // Expand taller than nav items

        // Find closest and highlight
        const { item: closest } = findClosestItem(mouseX, mouseY);
        updateHighlight(closest);

        // Update specular highlight - calculate from mouse to current selector position
        const selectorCenterX = currentX + currentW / 2;
        const selectorCenterY = currentY + currentH / 2;
        const localX = mouseX - navRect.left - selectorCenterX;
        const localY = mouseY - navRect.top - selectorCenterY;

        // Use smaller multiplier for more subtle movement
        document.documentElement.style.setProperty(
          "--lg-mx",
          `${localX * 0.15}px`,
        );
        document.documentElement.style.setProperty(
          "--lg-my",
          `${localY * 0.15}px`,
        );
      });

      // Mouse leave: snap back to active
      nav.addEventListener("mouseleave", () => {
        isHovering = false;
        selector.classList.remove("lg-hovering"); // Disable glass effect
        if (raf) {
          cancelAnimationFrame(raf);
          raf = null;
        }

        items.forEach((el) => el.classList.remove("lg-island-link--highlight"));

        // Smooth return to active item
        if (activeItem) {
          const navRect = nav.getBoundingClientRect();
          const itemRect = activeItem.getBoundingClientRect();
          targetX = itemRect.left - navRect.left;
          targetY = itemRect.top - navRect.top;
          targetW = itemRect.width;
          targetH = itemRect.height;
        }

        // One final animation frame to smooth return
        const returnEase = () => {
          const ease = 0.12;
          currentX = lerp(currentX, targetX, ease);
          currentY = lerp(currentY, targetY, ease);
          currentW = lerp(currentW, targetW, ease);
          currentH = lerp(currentH, targetH, ease);
          updateSelectorCSS();

          const delta =
            Math.abs(currentX - targetX) + Math.abs(currentY - targetY);
          if (delta > 0.5) {
            requestAnimationFrame(returnEase);
          }
        };
        returnEase();

        // Reset specular
        document.documentElement.style.setProperty("--lg-mx", "0px");
        document.documentElement.style.setProperty("--lg-my", "0px");
      });

      // Click: update active item
      items.forEach((el) => {
        el.addEventListener("click", () => {
          activeItem = el;
        });
      });

      // Resize: recalculate
      window.addEventListener(
        "resize",
        () => {
          if (!isHovering) snapToActive();
        },
        { passive: true },
      );
    })();

    // Navbar: distance-based trigger (no hysteresis)
    (() => {
      const heroHeading = document.querySelector("#hero h1");
      const navbar = document.querySelector(".home-island");
      if (!heroHeading || !navbar) return;

      let navShiftX = 0;
      const measureNavShift = () => {
        const main = document.querySelector(".main-column");
        if (!main) return;

        const navRect = navbar.getBoundingClientRect();
        const mainRect = main.getBoundingClientRect();

        const navCenter = navRect.left + navRect.width / 2;
        const mainCenter = mainRect.left + mainRect.width / 2;

        navShiftX = Math.round(mainCenter - navCenter);
      };

      const checkNav = () => {
        const navRect = navbar.getBoundingClientRect();
        const heroRect = heroHeading.getBoundingClientRect();
        const distance = heroRect.top - navRect.bottom;

        const scrolled = distance < 20;
        document.body.setAttribute(
          "data-nav-scrolled",
          scrolled ? "true" : "false",
        );

        // Set CSS variable instead of inline style
        document.documentElement.style.setProperty(
          "--nav-shift-x",
          scrolled ? `${navShiftX}px` : "0px",
        );
      };

      window.addEventListener("scroll", checkNav, { passive: true });
      window.addEventListener("resize", () => {
        measureNavShift();
        checkNav();
      });
      measureNavShift();
      checkNav();
    })();

    // Sidebar: top-edge trigger (no hysteresis)
    (() => {
      const checkSidebar = () => {
        const sidebar = document.querySelector(".home-sidebar");
        if (!sidebar) return;

        const sidebarRect = sidebar.getBoundingClientRect();
        document.body.setAttribute(
          "data-sidebar-scrolled",
          sidebarRect.top <= 10 ? "true" : "false",
        );
      };

      window.addEventListener("scroll", checkSidebar, { passive: true });
      window.addEventListener("resize", checkSidebar);
      checkSidebar();
    })();
  </script>
</BaseLayout>
