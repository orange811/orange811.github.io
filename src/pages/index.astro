---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import ThemeToggle from "../components/ThemeToggle.astro";

const projects = await getCollection("projects").catch(() => []);
const publications = await getCollection("publications").catch(() => []);
const art = await getCollection("art").catch(() => []);
const featured = Array.isArray(projects) ? projects.slice(0, 3) : [];
---

<BaseLayout
  title="Piyush Jain - Portfolio"
  description="Welcome to my portfolio and personal website"
>
  <!-- SVG Filter for glass distortion effect -->
  <svg width="0" height="0" style="position: absolute;">
    <defs>
      <filter id="glass-distortion" x="-20%" y="-20%" width="140%" height="140%">
        <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" result="noise" seed="2"/>
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
      </filter>
    </defs>
  </svg>

  <!-- Content wrapper for proper navbar positioning -->
  <div class="container-wrapper">
    <!-- Floating navbar island (transitions to sticky top) -->
    <div class="home-island sticky z-40 hidden md:block">
      <nav
        class="glass-island px-4 py-2 rounded-full border flex items-center gap-2"
      >
        <!-- Glass selector element (moves between items) -->
        <div class="glass-selector" aria-hidden="true"></div>
        
        <a href="/" class="island-link island-active" data-nav-item>Home</a>
        <a href="/academics" class="island-link" data-nav-item>Academics</a>
        <a href="/publications-research-projects" class="island-link" data-nav-item
          >Publications, Research & Projects</a
        >
        <a href="/art" class="island-link" data-nav-item>Art</a>
        <a href="/experience" class="island-link" data-nav-item>Experience</a>
        <a href="/resume" class="island-link" data-nav-item>Resume</a>
        <ThemeToggle />
      </nav>
    </div>

    <!-- Page content grid: left about sidebar + right main -->
    <div class="lg:grid lg:grid-cols-[minmax(280px,380px)_1fr] lg:gap-8">
      <!-- Left: About / Identity Sidebar (mobile becomes top card) -->
      <div class="lg:block">
        <!-- Mobile: stacked about card -->
        <div class="lg:hidden mb-6">
          <aside
            class="rounded-2xl border border-[rgb(var(--border-color))] bg-[rgb(var(--bg-primary))] p-6"
          >
            <h2 class="text-2xl font-bold mb-2">Hi, I'm Piyush Jain</h2>
            <p class="text-[rgb(var(--text-secondary))]">
              About me â€“ identity blurb. Content coming soon.
            </p>
          </aside>
        </div>

        <!-- Desktop: morphing tall card -> full-height sticky sidebar -->
        <div class="hidden lg:block lg:sticky lg:top-0 home-sidebar-container">
          <aside
            class="home-sidebar border border-[rgb(var(--border-color))] bg-[rgb(var(--bg-primary))"
          >
            <div class="p-6">
              <h2 class="text-3xl font-bold mb-3">Hi, I'm Piyush Jain</h2>
              <p class="text-[rgb(var(--text-secondary))] mb-4">
                I work across research, engineering, and creative practice.
              </p>
              <div class="flex gap-3">
                <a
                  href="/publications-research-projects"
                  class="px-4 py-2 rounded-md bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200"
                  >View Work</a
                >
                <a
                  href="/resume"
                  class="px-4 py-2 rounded-md border border-[rgb(var(--border-color))] hover:bg-slate-50 dark:hover:bg-slate-800"
                  >Resume</a
                >
              </div>
            </div>
          </aside>
        </div>
      </div>

      <!-- Right: Main content (Hero + Resume-like sections) -->
      <div class="main-column">
        <!-- Hero: full viewport -->
        <section
          id="hero"
          class="min-h-screen pt-8 pb-14 md:pt-12 md:pb-16 lg:pt-14 lg:pb-20 flex flex-col justify-start"
        >
          <div class="max-w-3xl">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">
              Hi, I'm <span class="text-slate-700 dark:text-slate-300"
                >Piyush Jain</span
              >
            </h1>
            <p
              class="text-lg md:text-xl text-[rgb(var(--text-secondary))] mb-8"
            >
              Featured work and directions below. Explore publications,
              research, and projects.
            </p>
            <div class="flex flex-wrap gap-4 mb-10">
              <a
                href="/publications-research-projects"
                class="px-6 py-3 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-md font-medium hover:bg-slate-800 dark:hover:bg-slate-200 transition-colors"
                >Explore Work</a
              >
              <a
                href="/resume"
                class="px-6 py-3 border border-[rgb(var(--border-color))] rounded-md font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                >View Resume</a
              >
            </div>
          </div>

          <!-- Featured Projects grid (layout placeholders or real items) -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {
              featured && featured.length > 0
                ? featured.map((item) => (
                    <div class="rounded-xl border border-[rgb(var(--border-color))] p-5 hover:shadow-md transition-shadow bg-[rgb(var(--bg-secondary))]">
                      <h3 class="text-lg font-semibold mb-1">
                        {item.data?.title ?? "Featured"}
                      </h3>
                      <p class="text-sm text-[rgb(var(--text-secondary))] line-clamp-3">
                        {item.data?.description ?? "Featured item"}
                      </p>
                    </div>
                  ))
                : [1, 2, 3].map((n) => (
                    <div class="rounded-xl border border-[rgb(var(--border-color))] p-5 hover:shadow-md transition-shadow bg-[rgb(var(--bg-secondary))]">
                      <h3 class="text-lg font-semibold mb-1">Featured</h3>
                      <p class="text-sm text-[rgb(var(--text-secondary))]">
                        Coming soon
                      </p>
                    </div>
                  ))
            }
          </div>
        </section>

        <!-- Resume-like scroll sections -->
        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Academics</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/academics" class="text-sm font-medium underline">See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">
            Publications, Research & Projects
          </h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-3">
            {
              (publications?.slice(0, 3) || []).map((p) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {p.data?.title ?? "Publication"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {p.data?.venue ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (projects?.slice(0, 3) || []).map((prj) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {prj.data?.title ?? "Project"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {prj.data?.description ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (publications?.length ?? 0) + (projects?.length ?? 0) === 0 && (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm">Content coming soon.</div>
                </div>
              )
            }
          </div>
          <a
            href="/publications-research-projects"
            class="text-sm font-medium underline">See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Art</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-3">
            {
              (art?.slice(0, 3) || []).map((a) => (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm font-semibold">
                    {a.data?.title ?? "Art"}
                  </div>
                  <div class="text-xs text-[rgb(var(--text-secondary))]">
                    {a.data?.medium ?? ""}
                  </div>
                </div>
              ))
            }
            {
              (art?.length ?? 0) === 0 && (
                <div class="rounded-lg border border-[rgb(var(--border-color))] p-4">
                  <div class="text-sm">Content coming soon.</div>
                </div>
              )
            }
          </div>
          <a href="/art" class="text-sm font-medium underline">See more</a>
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Experience</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/experience" class="text-sm font-medium underline"
            >See more</a
          >
        </section>

        <section class="py-10 border-t border-[rgb(var(--border-color))]">
          <h2 class="text-2xl font-bold mb-4">Resume</h2>
          <p class="text-[rgb(var(--text-secondary))] mb-3">
            Content coming soon.
          </p>
          <a href="/resume" class="text-sm font-medium underline">See more</a>
        </section>
      </div>
    </div>
  </div>

  <!-- Home-only styles and behavior -->
  <style is:global>
    /* Container wrapper for content-relative positioning */
    html,
    body {
      overflow-x: clip;
    }

    .container-wrapper {
      max-width: min(96vw, 1600px);
      margin: 0 auto;
      padding: 0 1rem;
      position: relative;
    }

    /* Hide normal navbar on home page only and remove from layout */
    body .site-nav {
      display: none !important;
      visibility: hidden;
    }

    /* Island smooth transition centered in content */
    .home-island {
      top: 1rem;
      display: flex;
      justify-content: center;
      contain: paint;
      transition:
        top 300ms cubic-bezier(0.4, 0, 0.2, 1),
        transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    body[data-nav-scrolled="true"] .home-island {
      top: 0.75rem;
    }

    /* Liquid glass island styling - solid gradient base pill */
    .glass-island {
      background: linear-gradient(
        180deg,
        color-mix(in oklab, rgb(var(--bg-primary)) 85%, rgba(255, 255, 255, 0.5)),
        color-mix(in oklab, rgb(var(--bg-primary)) 75%, rgba(200, 200, 200, 0.3))
      );
      backdrop-filter: blur(20px) saturate(1.4);
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    /* Subtle highlight on base pill */
    .glass-island::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.25),
        transparent 50%
      );
      pointer-events: none;
      z-index: 0;
    }

    /* Glass selector - moves smoothly between items */
    .glass-selector {
      position: absolute;
      top: 0.125rem;
      left: var(--selector-left, 0.25rem);
      width: var(--selector-width, 0px);
      height: calc(100% - 0.25rem);
      border-radius: 999px;
      pointer-events: none;
      z-index: 0;
      transition: left 350ms cubic-bezier(0.4, 0, 0.2, 1),
                  width 350ms cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 250ms ease-out;
      opacity: var(--selector-opacity, 0);
      
      /* Glass appearance */
      background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.85),
        rgba(255, 255, 255, 0.6)
      );
      backdrop-filter: blur(12px) saturate(1.8);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 2px rgba(0, 0, 0, 0.05),
        0 8px 20px rgba(0, 0, 0, 0.12),
        0 2px 6px rgba(0, 0, 0, 0.08);
      
      /* SVG filter for edge distortion */
      filter: url(#glass-distortion);
    }

    /* Specular highlight on glass selector */
    .glass-selector::before {
      content: "";
      position: absolute;
      top: 1px;
      left: 15%;
      right: 15%;
      height: 35%;
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.7),
        transparent
      );
      pointer-events: none;
    }

    /* Subtle noise texture on glass */
    .glass-selector::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.03;
      mix-blend-mode: overlay;
      pointer-events: none;
    }

    .island-link {
      position: relative;
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
      color: rgb(var(--text-primary));
      z-index: 1;
      transition: color 200ms ease-out;
      white-space: nowrap;
    }

    /* Highlight text when selector is active */
    .island-link[data-highlighted="true"] {
      color: rgb(var(--text-primary));
      text-shadow: 0 0 1px rgba(255, 255, 255, 0.5);
    }

    /* Ensure theme toggle is clickable */
    .glass-island > * {
      position: relative;
      z-index: 1;
    }

    #theme-toggle {
      position: relative;
      z-index: 10;
      pointer-events: auto;
      cursor: pointer;
    }

    /* Active link indication for keyboard navigation */
    .island-active {
      color: rgb(var(--text-primary));
    }
    
    .island-link:focus-visible {
      outline: 2px solid rgb(var(--text-primary));
      outline-offset: 2px;
    }

    /* Sidebar container positioning */
    .home-sidebar-container {
      margin-top: 20vh;
      transition: margin-top 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    body[data-sidebar-scrolled="true"] .home-sidebar-container {
      margin-top: 0;
    }

    /* Sidebar morph behavior - borders fade, divider appears */
    .home-sidebar {
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      min-height: 100vh;
      padding: 1.5rem;
      position: relative;
      transition:
        border-radius 300ms cubic-bezier(0.4, 0, 0.2, 1),
        border-color 300ms cubic-bezier(0.4, 0, 0.2, 1),
        background-color 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Fade out borders and rounded corners when scrolled */
    body[data-sidebar-scrolled="true"] .home-sidebar {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-color: transparent;
      border-bottom-color: transparent;
    }

    /* Add vertical divider line with gaps when scrolled */
    body[data-sidebar-scrolled="true"] .home-sidebar::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 2rem;
      width: 1px;
      background: rgb(var(--border-color));
      opacity: 1;
      transition: opacity 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Hidden state for divider */
    .home-sidebar::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 2rem;
      width: 1px;
      background: rgb(var(--border-color));
      opacity: 0;
      transition: opacity 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>

  <script is:inline>
    // Glass Selector: Track hover/focus/active and update position/size
    (() => {
      const navbar = document.querySelector(".glass-island");
      const selector = document.querySelector(".glass-selector");
      const navItems = document.querySelectorAll(".island-link[data-nav-item]");
      
      if (!navbar || !selector || !navItems.length) return;

      let rafId = null;
      let currentTarget = null;

      // Find active item on page load
      const activeItem = document.querySelector(".island-link.island-active[data-nav-item]");
      
      // Update selector position and size
      const updateSelector = (target, show = true) => {
        if (!target) {
          selector.style.setProperty("--selector-opacity", "0");
          navItems.forEach(item => item.setAttribute("data-highlighted", "false"));
          return;
        }

        const navRect = navbar.getBoundingClientRect();
        const targetRect = target.getBoundingClientRect();
        
        const left = targetRect.left - navRect.left;
        const width = targetRect.width;
        
        selector.style.setProperty("--selector-left", `${left}px`);
        selector.style.setProperty("--selector-width", `${width}px`);
        selector.style.setProperty("--selector-opacity", show ? "1" : "0");
        
        // Highlight text beneath selector
        navItems.forEach(item => {
          item.setAttribute("data-highlighted", item === target ? "true" : "false");
        });
        
        currentTarget = target;
      };

      // RAF-throttled update
      const scheduleUpdate = (target, show) => {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          updateSelector(target, show);
          rafId = null;
        });
      };

      // Mouse hover handlers
      navItems.forEach(item => {
        item.addEventListener("mouseenter", () => {
          scheduleUpdate(item, true);
        });
      });

      navbar.addEventListener("mouseleave", () => {
        // Return to active item or hide
        scheduleUpdate(activeItem, !!activeItem);
      });

      // Keyboard focus handlers
      navItems.forEach(item => {
        item.addEventListener("focus", () => {
          scheduleUpdate(item, true);
        });
        
        item.addEventListener("blur", () => {
          // Small delay to allow focus to move to another nav item
          setTimeout(() => {
            const focusedNavItem = document.querySelector(".island-link[data-nav-item]:focus");
            if (!focusedNavItem) {
              scheduleUpdate(activeItem, !!activeItem);
            }
          }, 50);
        });
      });

      // Handle window resize with throttling
      let resizeTimeout;
      window.addEventListener("resize", () => {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (currentTarget) {
            scheduleUpdate(currentTarget, true);
          }
        }, 150);
      });

      // Initialize with active item
      if (activeItem) {
        // Delay initial animation slightly for smoother load
        setTimeout(() => updateSelector(activeItem, true), 100);
      }
    })();

    // Navbar: distance-based trigger (no hysteresis)
    (() => {
      let navShiftX = 0;
      const measureNavShift = () => {
        const main = document.querySelector(".main-column");
        if (!main || !navbar) return;

        const navRect = navbar.getBoundingClientRect();
        const mainRect = main.getBoundingClientRect();

        const navCenter = navRect.left + navRect.width / 2;
        const mainCenter = mainRect.left + mainRect.width / 2;

        navShiftX = Math.round(mainCenter - navCenter);
      };

      const heroHeading = document.querySelector("#hero h1");
      const navbar = document.querySelector(".home-island");
      if (!heroHeading || !navbar) return;
      const checkNav = () => {
        const navRect = navbar.getBoundingClientRect();
        const heroRect = heroHeading.getBoundingClientRect();
        const distance = heroRect.top - navRect.bottom;

        const scrolled = distance < 20;
        document.body.setAttribute(
          "data-nav-scrolled",
          scrolled ? "true" : "false",
        );

        navbar.style.transform = scrolled
          ? `translateX(${navShiftX}px)`
          : "translateX(0px)";
      };

      window.addEventListener("scroll", checkNav, { passive: true });
      window.addEventListener("resize", () => {
        measureNavShift();
        checkNav();
      });
      measureNavShift();
      checkNav();
    })();

    // Sidebar: top-edge trigger (no hysteresis)
    (() => {
      const checkSidebar = () => {
        const sidebar = document.querySelector(".home-sidebar");
        if (!sidebar) return;

        const sidebarRect = sidebar.getBoundingClientRect();
        document.body.setAttribute(
          "data-sidebar-scrolled",
          sidebarRect.top <= 10 ? "true" : "false",
        );
      };

      window.addEventListener("scroll", checkSidebar, { passive: true });
      window.addEventListener("resize", checkSidebar);
      checkSidebar();
    })();
  </script>
</BaseLayout>
